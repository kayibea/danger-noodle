var C=Object.defineProperty;var L=(i,t,s)=>t in i?C(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var n=(i,t,s)=>L(i,typeof t!="symbol"?t+"":t,s);import{g as k}from"./index-lqGehr8V.js";class e{constructor(t=0,s=0){this.x=t,this.y=s}unpack(){return[this.x,this.y]}mul(t){return new e(this.x*t,this.y*t)}add(t){return new e(this.x+t.x,this.y+t.y)}sub(t){return new e(this.x-t.x,this.y-t.y)}clone(){return new e(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}static get up(){return new e(0,-1)}static get down(){return new e(0,1)}static get left(){return new e(-1,0)}static get right(){return new e(1,0)}}const f=class f{constructor(){n(this,"frametimes",new Array(f.maxSample));n(this,"fps",0)}update(t){this.frametimes.push(t),this.frametimes.length>f.maxSample&&this.frametimes.shift(),this.fps=1e3/this.avgFrametime}get avgFrametime(){return this.frametimes.reduce((t,s)=>t+s,0)/this.frametimes.length}draw(t){t.fillStyle="black",t.fillRect(0,0,40,20),t.fillStyle="white",t.font="bold 15px Roboto",t.fillText(this.fps.toFixed(0),5,15)}};n(f,"maxSample",100);let b=f;class y{constructor(t=0,s=0,o=0,a=1){n(this,"r");n(this,"g");n(this,"b");n(this,"a");this.r=t,this.g=s,this.b=o,this.a=a}alpha(t){return new y(this.r,this.g,this.b,t)}toString(){return`rgba(${[this.r,this.g,this.b,this.a].join(",")})`}}const F=/^rgba\(\s*(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\s*,\s*(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\s*,\s*(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\s*,\s*(0|1|0?\.\d+)\s*\)$/;class T{constructor(t){n(this,"color");this.position=t,this.color=new y(0,0,0).toString()}getColor(){return this.color}setColor(t){if(!F.test(t)){console.error(`Could not set food color, invalid color. (${t})`);return}this.color=t}setPosition(t){this.position.x=t.x,this.position.y=t.y}}const M={ArrowUp:e.up,w:e.up,W:e.up,z:e.up,Z:e.up,ArrowDown:e.down,s:e.down,S:e.down,ArrowLeft:e.left,a:e.left,A:e.left,q:e.left,Q:e.left,ArrowRight:e.right,d:e.right,D:e.right};class D{constructor(){n(this,"direction");n(this,"_body");n(this,"headColor");n(this,"bodyColor");n(this,"moveIntvl");n(this,"lastMoveTime");n(this,"inputQueue");n(this,"inputListenerFn");const t=new y(4,129,81);this.headColor=t.toString(),this.bodyColor=t.alpha(.5).toString(),this._body=[],this._body.push(new e(0,0)),this._body.push(new e(0,0).add(e.right)),this.inputQueue=[],this.moveIntvl=30,this.lastMoveTime=0,this.direction=e.right,this.inputListenerFn=this.inputListener.bind(this)}canMove(){return this.lastMoveTime>this.moveIntvl}move(){this._body.unshift(this.head.add(this.direction)),this._body.pop(),this.lastMoveTime=0}grow(){const t=this._body.at(-1);this._body.push(t.sub(this.direction))}handleDirection(){const t=this.dequeueDirection();t&&!t.equals(this.direction.mul(-1))&&(this.direction.x=t.x,this.direction.y=t.y)}get head(){return this._body[0]}get body(){return this._body.slice(1)}update(t){this.lastMoveTime+=t,this.canMove()&&(this.move(),this.handleDirection())}didSnakeBiteIself(){return this.body.some(t=>this.head.equals(t))}keyToDirection(t){return M[t]??null}dequeueDirection(){for(;this.inputQueue.length>0;){const t=this.inputQueue.shift();if(t&&!t.equals(this.direction)&&!t.equals(this.direction.mul(-1)))return t}return null}inputListener(t){const s=this.keyToDirection(t.key);s&&this.inputQueue.push(s)}removeListeners(){window.removeEventListener("keydown",this.inputListenerFn)}setupListeners(){this.removeListeners(),window.addEventListener("keydown",this.inputListenerFn)}}const E=(i,t)=>Math.abs(i.x-t.x)+Math.abs(i.y-t.y),v=(i,t,s)=>i.x<0||i.y<0||i.x>=t||i.y>=s,S=({x:i,y:t})=>[{x:i+1,y:t},{x:i-1,y:t},{x:i,y:t+1},{x:i,y:t-1}],R=(i,t,s,o)=>{let a=0;for(const r of S(t))(v(r,s,o)||i[r.y][r.x]!==0)&&a++;return a},q=(i,t,s,o,a=100)=>{const r=new Set,u=[t];let d=0;for(;u.length&&d<a;){const{x:h,y:l}=u.shift(),w=`${h},${l}`;if(!r.has(w)){r.add(w),d++;for(const c of S({x:h,y:l})){const g=`${c.x},${c.y}`;!v(c,s,o)&&i[c.y][c.x]===0&&!r.has(g)&&u.push(c)}}}return d},A=(i,t,s,o)=>{const a=t[0],r=[];for(let h=0;h<o;h++)for(let l=0;l<s;l++)i[h][l]===0&&r.push({x:l,y:h});let u=-1/0,d=[];for(const h of r){const l=E(a,h),w=q(i,h,s,o,20),c=R(i,h,s,o),g=t.length,m=-l*(g<10?10:3)+w*5-c*10;m>u?(u=m,d=[h]):m===u&&d.push(h)}return d[Math.floor(Math.random()*d.length)]},p=class p{constructor(t){n(this,"perfM");n(this,"cols");n(this,"rows");n(this,"cellW");n(this,"cellH");n(this,"snake");n(this,"ctx");n(this,"maxFoodSpawn");n(this,"foods");this.canvas=t,this.cols=Math.floor(t.width/p.TARGET_CELL_SIZE),this.rows=Math.floor(t.height/p.TARGET_CELL_SIZE),this.cellW=t.width/this.cols,this.cellH=t.height/this.rows,this.perfM=new b,this.snake=new D,this.foods=[],this.maxFoodSpawn=1,this.setupCanvasRenderingContext2D()}didSnakeChomp(){const t=this.foods.findIndex(({position:s})=>s.equals(this.snake.head));return t!==-1?(this.foods.splice(t,1),!0):!1}spawnFood(t){const s=new T(new e(t.x,t.y));s.setColor(this.snake.headColor),this.foods.push(s)}spawnFoods(){const t=Array.from({length:this.rows},()=>Array(this.cols).fill(0));for(const s of this.snake.body)t[s.y][s.x]=1;for(const s of this.foods){const o=s.position;t[o.y][o.x]=1}for(let s=0;s<=this.maxFoodSpawn-this.foods.length;s++){const o=A(t,this.snake.body,this.cols,this.rows);t[o.y][o.x]=1,this.spawnFood(o)}}drawFoods(t){for(const s of this.foods){t.fillStyle=s.getColor();const o=s.position;t.fillRect(o.x*this.cellW,o.y*this.cellH,this.cellW,this.cellH)}}drawSnake(t){const s=this.snake.head;t.fillStyle=this.snake.headColor,t.beginPath(),t.rect(s.x*this.cellW,s.y*this.cellH,this.cellW,this.cellH),t.fill(),t.fillStyle=this.snake.bodyColor,t.beginPath();for(const o of this.snake.body)t.rect(o.x*this.cellW,o.y*this.cellH,this.cellW,this.cellH);t.fill()}drawGrid(t){t.strokeStyle="#e0e0e0",t.beginPath();for(let s=0;s<=this.cols;s++){const o=s*this.cellW;t.moveTo(o,0),t.lineTo(o,this.rows*this.cellH)}for(let s=0;s<=this.rows;s++){const o=s*this.cellH;t.moveTo(0,o),t.lineTo(this.cols*this.cellW,o)}t.stroke()}setupCanvasRenderingContext2D(){const t=this.canvas.getContext("2d");if(!t)throw new Error("Could not get CanvasRenderingContext2D !");this.ctx=t}};n(p,"TARGET_CELL_SIZE",10);let x=p;class H extends x{constructor(t){super(t),this.canvas=t,console.log(this.cols,this.rows),this.spawnFoods()}update(t){if(this.snake.update(t),this.perfM.update(t),this.snake.didSnakeBiteIself()){k.isGameOver=!0;return}this.didSnakeChomp()&&(k.score+=1,this.spawnFoods(),this.snake.grow())}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawFoods(this.ctx),this.drawSnake(this.ctx)}setupListeners(){this.snake.setupListeners()}removeListeners(){this.snake.removeListeners()}}export{H as default};
