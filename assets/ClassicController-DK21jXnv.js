var C=Object.defineProperty;var L=(i,t,s)=>t in i?C(i,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[t]=s;var n=(i,t,s)=>L(i,typeof t!="symbol"?t+"":t,s);import{g as k}from"./index-4k4lw5N7.js";class o{constructor(t=0,s=0){this.x=t,this.y=s}unpack(){return[this.x,this.y]}mul(t){return new o(this.x*t,this.y*t)}add(t){return new o(this.x+t.x,this.y+t.y)}sub(t){return new o(this.x-t.x,this.y-t.y)}clone(){return new o(this.x,this.y)}equals(t){return this.x===t.x&&this.y===t.y}static get up(){return new o(0,-1)}static get down(){return new o(0,1)}static get left(){return new o(-1,0)}static get right(){return new o(1,0)}}const f=class f{constructor(){n(this,"frametimes",new Array(f.maxSample));n(this,"fps",0)}update(t){this.frametimes.push(t),this.frametimes.length>f.maxSample&&this.frametimes.shift(),this.fps=1e3/this.avgFrametime}get avgFrametime(){return this.frametimes.reduce((t,s)=>t+s,0)/this.frametimes.length}draw(t){t.fillStyle="black",t.fillRect(0,0,40,20),t.fillStyle="white",t.font="bold 15px Roboto",t.fillText(this.fps.toFixed(0),5,15)}};n(f,"maxSample",100);let b=f;class y{constructor(t=0,s=0,e=0,r=1){n(this,"r");n(this,"g");n(this,"b");n(this,"a");this.r=t,this.g=s,this.b=e,this.a=r}alpha(t){return new y(this.r,this.g,this.b,t)}toString(){return`rgba(${[this.r,this.g,this.b,this.a].join(",")})`}}const F=/^rgba\(\s*(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\s*,\s*(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\s*,\s*(?:25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)\s*,\s*(0|1|0?\.\d+)\s*\)$/;class T{constructor(t){n(this,"color");this.position=t,this.color=new y(0,0,0).toString()}getColor(){return this.color}setColor(t){if(!F.test(t)){console.error(`Could not set food color, invalid color. (${t})`);return}this.color=t}setPosition(t){this.position.x=t.x,this.position.y=t.y}}const M={ArrowUp:o.up,w:o.up,W:o.up,z:o.up,Z:o.up,ArrowDown:o.down,s:o.down,S:o.down,ArrowLeft:o.left,a:o.left,A:o.left,q:o.left,Q:o.left,ArrowRight:o.right,d:o.right,D:o.right};class D{constructor(){n(this,"direction");n(this,"body");n(this,"headColor");n(this,"bodyColor");n(this,"moveIntvl");n(this,"lastMoveTime");n(this,"inputQueue");n(this,"inputListenerFn");const t=new y(4,129,81);this.headColor=t.toString(),this.bodyColor=t.alpha(.5).toString(),this.inputQueue=[],this.moveIntvl=100,this.lastMoveTime=0,this.direction=o.right,this.body=[],this.body.push(new o(0,0)),this.grow(),this.inputListenerFn=this.inputListener.bind(this)}canMove(){return this.lastMoveTime>=this.moveIntvl}move(){this.body.unshift(this.head.add(this.direction)),this.body.pop(),this.lastMoveTime=0}grow(){const t=this.body.at(-1);this.body.push(t.sub(this.direction))}handleDirection(){const t=this.dequeueDirection();t&&!t.equals(this.direction.mul(-1))&&(this.direction.x=t.x,this.direction.y=t.y)}get head(){return this.body[0]}update(t){this.lastMoveTime+=t,this.canMove()&&(this.handleDirection(),this.move())}didBiteIself(){const t=this.head;for(let s=1;s<this.body.length;s++){const e=this.body[s];if(t.equals(e))return!0}return!1}keyToDirection(t){return M[t]??null}dequeueDirection(){for(;this.inputQueue.length>0;){const t=this.inputQueue.shift();if(t&&!t.equals(this.direction)&&!t.equals(this.direction.mul(-1)))return t}return null}inputListener(t){const s=this.keyToDirection(t.key);s&&this.inputQueue.push(s)}removeListeners(){window.removeEventListener("keydown",this.inputListenerFn)}setupListeners(){this.removeListeners(),window.addEventListener("keydown",this.inputListenerFn)}}const E=(i,t)=>Math.abs(i.x-t.x)+Math.abs(i.y-t.y),v=(i,t,s)=>i.x<0||i.y<0||i.x>=t||i.y>=s,S=({x:i,y:t})=>[{x:i+1,y:t},{x:i-1,y:t},{x:i,y:t+1},{x:i,y:t-1}],R=(i,t,s,e)=>{let r=0;for(const l of S(t))(v(l,s,e)||i[l.y][l.x]!==0)&&r++;return r},q=(i,t,s,e,r=100)=>{const l=new Set,u=[t];let d=0;for(;u.length&&d<r;){const{x:h,y:a}=u.shift(),w=`${h},${a}`;if(!l.has(w)){l.add(w),d++;for(const c of S({x:h,y:a})){const g=`${c.x},${c.y}`;!v(c,s,e)&&i[c.y][c.x]===0&&!l.has(g)&&u.push(c)}}}return d},A=(i,t,s,e)=>{const r=t[0],l=[];for(let h=0;h<e;h++)for(let a=0;a<s;a++)i[h][a]===0&&l.push({x:a,y:h});let u=-1/0,d=[];for(const h of l){const a=E(r,h),w=q(i,h,s,e,20),c=R(i,h,s,e),g=t.length,m=-a*(g<10?10:3)+w*5-c*10;m>u?(u=m,d=[h]):m===u&&d.push(h)}return d[Math.floor(Math.random()*d.length)]},p=class p{constructor(t){n(this,"perfM");n(this,"cols");n(this,"rows");n(this,"cellW");n(this,"cellH");n(this,"snake");n(this,"ctx");n(this,"maxFoodSpawn");n(this,"foods");this.canvas=t,this.cols=Math.floor(t.width/p.TARGET_CELL_SIZE),this.rows=Math.floor(t.height/p.TARGET_CELL_SIZE),this.cellW=t.width/this.cols,this.cellH=t.height/this.rows,this.perfM=new b,this.snake=new D,this.foods=[],this.maxFoodSpawn=1,this.setupCanvasRenderingContext2D()}didChomp(){const t=this.foods.findIndex(({position:s})=>s.equals(this.snake.head));return t!==-1?(this.foods.splice(t,1),!0):!1}spawnFood(t){const s=new T(new o(t.x,t.y));s.setColor(this.snake.headColor),this.foods.push(s)}spawnFoods(){const t=Array.from({length:this.rows},()=>Array(this.cols).fill(0));for(const s of this.snake.body)v(s,this.cols,this.rows)||(t[s.y][s.x]=1);for(const s of this.foods){const e=s.position;t[e.y][e.x]=1}for(let s=0;s<=this.maxFoodSpawn-this.foods.length;s++){const e=A(t,this.snake.body,this.cols,this.rows);t[e.y][e.x]=1,this.spawnFood(e)}}drawFoods(t){for(const s of this.foods){t.fillStyle=s.getColor();const e=s.position;t.fillRect(e.x*this.cellW,e.y*this.cellH,this.cellW,this.cellH)}}drawSnake(t){const s=this.snake.head;t.fillStyle=this.snake.headColor,t.beginPath(),t.rect(s.x*this.cellW,s.y*this.cellH,this.cellW,this.cellH),t.fill(),t.fillStyle=this.snake.bodyColor,t.beginPath();for(let e=1;e<this.snake.body.length;e++){const r=this.snake.body[e];t.rect(r.x*this.cellW,r.y*this.cellH,this.cellW,this.cellH)}t.fill()}drawGrid(t){t.strokeStyle="#e0e0e0",t.beginPath();for(let s=0;s<=this.cols;s++){const e=s*this.cellW;t.moveTo(e,0),t.lineTo(e,this.rows*this.cellH)}for(let s=0;s<=this.rows;s++){const e=s*this.cellH;t.moveTo(0,e),t.lineTo(this.cols*this.cellW,e)}t.stroke()}setupCanvasRenderingContext2D(){const t=this.canvas.getContext("2d");if(!t)throw new Error("Could not get CanvasRenderingContext2D !");this.ctx=t}};n(p,"TARGET_CELL_SIZE",30);let x=p;class H extends x{constructor(t){super(t),this.canvas=t,console.log(this.cols,this.rows),this.spawnFoods()}update(t){this.snake.update(t),this.perfM.update(t),this.snake.didBiteIself()&&(k.isGameOver=!0),this.didChomp()&&(k.score+=1,this.spawnFoods(),this.snake.grow())}render(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawFoods(this.ctx),this.drawSnake(this.ctx)}setupListeners(){this.snake.setupListeners()}removeListeners(){this.snake.removeListeners()}}export{H as default};
